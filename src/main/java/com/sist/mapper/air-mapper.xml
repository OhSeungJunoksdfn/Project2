<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sist.mapper.AirMapper">
  <!-- 1) AIRLINES 전체 조회 -->
  <select id="selectAirlines"
          resultType="com.sist.vo.air.AirLinesVO">
    SELECT
      AIRLINE_ID      AS airline_id,
      AIRLINE_CODE    AS airline_code,
      AIRLINE_NAME_EN AS airline_name_en,
      AIRLINE_NAME_KO AS airline_name_ko
    FROM AIRLINES
    ORDER BY AIRLINE_NAME_KO
  </select>

  <!-- 2) AIRPORTS 전체 조회 -->
  <select id="selectAirports"
          resultType="com.sist.vo.air.AirportsVO">
    SELECT
      AIRPORT_ID      AS airport_id,
      AIRPORT_CODE    AS airport_code,
      AIRPORT_NAME_EN AS airport_name_en,
      AIRPORT_NAME_KO AS airport_name_ko,
      CITY            AS city,
      COUNTRY         AS country
    FROM AIRPORTS
    ORDER BY CITY, AIRPORT_NAME_EN
  </select>

  <!-- 3) FLIGHT_INFO 페이징 조회 (필터 없이) -->
  <select id="selectFlights"
          parameterType="map"
          resultType="com.sist.vo.air.FlightInfoVO">
    SELECT * FROM (
      SELECT f.*, ROWNUM rn
      FROM (
        SELECT
          flight_id,
          airline_code,
          flight_number,
          dep_airport_code,
          arr_airport_code,
          TO_CHAR(dep_time,'YYYY-MM-DD HH24:MI') AS dep_time,
          TO_CHAR(arr_time,'YYYY-MM-DD HH24:MI') AS arr_time,
          economy_charge,
          prestige_charge,
        FROM FLIGHT_INFO
        ORDER BY dep_time
      ) f
      WHERE ROWNUM &lt;= #{end}
    )
    WHERE rn &gt;= #{start}
  </select>

  <select id="selectFlightsCount"
          resultType="int">
    SELECT CEIL(COUNT(*)/20.0) FROM FLIGHT_INFO
  </select>

  <!-- 4) FLIGHT_INFO 상세 조회 -->
  <select id="selectFlightById"
          parameterType="int"
          resultType="com.sist.vo.air.FlightInfoVO">
    SELECT
      flight_id,
      airline_code,
      flight_number,
      dep_airport_code,
      arr_airport_code,
      TO_CHAR(dep_time,'YYYY-MM-DD HH24:MI') AS dep_time,
      TO_CHAR(arr_time,'YYYY-MM-DD HH24:MI') AS arr_time,
      economy_charge,
      prestige_charge,
    FROM FLIGHT_INFO
    WHERE flight_id = #{id}
  </select>

  <!-- 5) FLIGHT_INFO 필터 + 페이징 조회 -->
  <select id="selectFlightsFiltered"
          parameterType="map"
          resultType="com.sist.vo.air.FlightInfoVO">
    SELECT * FROM (
      SELECT f.*, ROWNUM rn
      FROM (
        SELECT
          flight_id,
          airline_code,
          flight_number,
          dep_airport_code,
          arr_airport_code,
          TO_CHAR(dep_time,'YYYY-MM-DD HH24:MI') AS dep_time,
          TO_CHAR(arr_time,'YYYY-MM-DD HH24:MI') AS arr_time,
          economy_charge,
          prestige_charge
        FROM FLIGHT_INFO
        WHERE dep_airport_code = #{from,jdbcType=VARCHAR}
          AND arr_airport_code = #{to,jdbcType=VARCHAR}
          AND TO_CHAR(dep_time,'YYYY-MM-DD') = #{arrtime,jdbcType=VARCHAR}
          AND TO_CHAR(arr_time,'YYYY-MM-DD') = #{deptime,jdbcType=VARCHAR}
        ORDER BY dep_time
      ) f
      WHERE ROWNUM &lt;= #{end}
    )
    WHERE rn &gt;= #{start}
  </select>

  <select id="selectFlightsCountFiltered"
          parameterType="map"
          resultType="int">
    SELECT CEIL(COUNT(*)/20.0)
      FROM FLIGHT_INFO
     WHERE dep_airport_code = #{from,jdbcType=VARCHAR}
       AND arr_airport_code = #{to,jdbcType=VARCHAR}
       AND TO_CHAR(dep_time,'YYYY-MM-DD') = #{arrtime,jdbcType=VARCHAR}
       AND TO_CHAR(arr_time,'YYYY-MM-DD') = #{deptime,jdbcType=VARCHAR}
  </select>

  <!-- 6) RESERVATIONS 삽입 -->
  <insert id="insertReservation"
          parameterType="com.sist.vo.air.ReservationsVO">
    INSERT INTO RESERVATIONS (
      RESERVATION_ID,
      FLIGHT_ID,
      BOOKING_NUMBER,
      CUSTOMER_NAME,
      CUSTOMER_EMAIL,
      BOOKING_DATE,
      PAYMENT_STATUS,
      CREATED_AT,
      UPDATED_AT
    ) VALUES (
      #{reservationId},
      #{flightId},
      #{bookingNumber},
      #{customerName},
      #{customerEmail},
      #{bookingDate},
      #{paymentStatus},
      #{createdAt},
      #{updatedAt}
    )
  </insert>

  <!-- 7) RESERVATIONS 조회 (이메일 기준) -->
  <select id="selectReservationsByEmail"
          parameterType="string"
          resultType="com.sist.vo.air.ReservationsVO">
    SELECT
      RESERVATION_ID   AS reservationId,
      FLIGHT_ID        AS flightId,
      BOOKING_NUMBER   AS bookingNumber,
      CUSTOMER_NAME    AS customerName,
      CUSTOMER_EMAIL   AS customerEmail,
      BOOKING_DATE     AS bookingDate,
      PAYMENT_STATUS   AS paymentStatus,
      CREATED_AT       AS createdAt,
      UPDATED_AT       AS updatedAt
    FROM RESERVATIONS
    WHERE CUSTOMER_EMAIL = #{email}
    ORDER BY BOOKING_DATE DESC
  </select>
  
  <!-- 8) 편도(가는 편) 조회 -->
  <select id="selectOutbound" parameterType="map" resultType="com.sist.vo.air.FlightInfoVO">
    SELECT * FROM (
      SELECT f.*, ROWNUM rn
      FROM (
        SELECT
          flight_id, airline_code, flight_number,
          dep_airport_code, arr_airport_code,
          TO_CHAR(dep_time,'YYYY-MM-DD HH24:MI') AS dep_time,
          TO_CHAR(arr_time,'YYYY-MM-DD HH24:MI') AS arr_time,
          economy_charge, prestige_charge
        FROM FLIGHT_INFO
        WHERE dep_airport_code = #{from}
          AND arr_airport_code = #{to}
          AND TO_CHAR(dep_time,'YYYY-MM-DD') = #{date}
        ORDER BY dep_time
      ) f
      WHERE ROWNUM &lt;= #{end}
    )
    WHERE rn &gt;= #{start}
  </select>

  <select id="countOutbound" parameterType="map" resultType="int">
    SELECT CEIL(COUNT(*)/20.0)
      FROM FLIGHT_INFO
     WHERE dep_airport_code = #{from}
       AND arr_airport_code = #{to}
       AND TO_CHAR(dep_time,'YYYY-MM-DD') = #{date}
  </select>

  <!-- 9) 왕복(오는 편) 조회: from/to 뒤집고 date는 돌아오는 날짜 -->
  <select id="selectInbound" parameterType="map" resultType="com.sist.vo.air.FlightInfoVO">
    SELECT * FROM (
      SELECT f.*, ROWNUM rn
      FROM (
        SELECT
          flight_id, airline_code, flight_number,
          dep_airport_code, arr_airport_code,
          TO_CHAR(dep_time,'YYYY-MM-DD HH24:MI') AS dep_time,
          TO_CHAR(arr_time,'YYYY-MM-DD HH24:MI') AS arr_time,
          economy_charge, prestige_charge
        FROM FLIGHT_INFO
        WHERE dep_airport_code = #{to}   <!--도착지→출발지-->
          AND arr_airport_code = #{from} <!--출발지→도착지-->
          AND TO_CHAR(dep_time,'YYYY-MM-DD') = #{date}
        ORDER BY dep_time
      ) f
      WHERE ROWNUM &lt;= #{end}
    )
    WHERE rn &gt;= #{start}
  </select>

  <select id="countInbound" parameterType="map" resultType="int">
    SELECT CEIL(COUNT(*)/20.0)
      FROM FLIGHT_INFO
     WHERE dep_airport_code = #{to}
       AND arr_airport_code = #{from}
       AND TO_CHAR(dep_time,'YYYY-MM-DD') = #{date}
  </select>

</mapper>